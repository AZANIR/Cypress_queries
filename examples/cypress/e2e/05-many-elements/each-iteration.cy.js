// ============================================================
// ТЕМА: Метод each() - ітерація через множину елементів
// ОПИС: Демонстрація використання each() для ітерації
//       та виконання дій над кожним елементом окремо
// ============================================================

describe('Метод each() - ітерація через елементи', () => {
  // Підготовка: відкриваємо сторінку та додаємо тестові дані
  beforeEach(() => {
    cy.visit('/')
    // Додаємо кілька задач для ітерації
    cy.get('.new-todo').type('Задача 1{enter}')
    cy.get('.new-todo').type('Задача 2{enter}')
    cy.get('.new-todo').type('Задача 3{enter}')
  })

  // Тест 1: Базове використання each()
  // each() - виконує функцію для кожного елемента в колекції
  it('має ітерувати через всі елементи', () => {
    // cy.get('.todo-list li') - знаходимо всі задачі
    // .each(($el) => { ... }) - виконуємо функцію для кожної задачі
    // $el - це jQuery елемент (поточний елемент в ітерації)
    cy.get('.todo-list li')
      .each(($el) => {
        // cy.wrap($el) - обгортаємо jQuery елемент в Cypress команду
        // Це дозволяє використовувати Cypress команди на елементі
        cy.wrap($el)
          // Перевіряємо, що кожна задача видима
          .should('be.visible')
      })
  })

  // Тест 2: each() з індексом та списком
  // each() може передавати індекс та весь список в функцію
  it('має використовувати індекс та список в each()', () => {
    // .each(($el, index, $list) => { ... })
    // $el - поточний елемент
    // index - індекс поточного елемента (починається з 0)
    // $list - весь список елементів
    cy.get('.todo-list li')
      .each(($el, index, $list) => {
        // Використовуємо індекс для перевірки
        // Очікуємо, що індекс менше загальної кількості
        expect(index).to.be.lessThan($list.length)
        
        // Перевіряємо поточний елемент
        cy.wrap($el)
          .should('be.visible')
      })
  })

  // Тест 3: each() для взаємодії з елементами
  // each() дозволяє взаємодіяти з кожним елементом окремо
  it('має взаємодіяти з кожним елементом через each()', () => {
    // Ітеруємо через всі задачі та відмічаємо кожну
    cy.get('.todo-list li')
      .each(($el) => {
        // Для кожної задачі знаходимо чекбокс та відмічаємо
        cy.wrap($el)
          .find('.toggle')
          .check()
      })
    
    // Перевіряємо, що всі задачі відмічені
    cy.get('.todo-list li.completed')
      .should('have.length', 3)
  })

  // Тест 4: each() для збору даних
  // each() можна використовувати для збору даних з елементів
  it('має збирати дані з елементів через each()', () => {
    // Створюємо масив для зберігання текстів
    const taskTexts = []
    
    // Збираємо тексти всіх задач
    cy.get('.todo-list li')
      .each(($el) => {
        // Отримуємо текст елемента через jQuery
        const text = $el.text()
        // Додаємо в масив
        taskTexts.push(text)
      })
      // .then() - виконується після завершення each()
      .then(() => {
        // Перевіряємо зібрані дані
        expect(taskTexts).to.have.length(3)
        expect(taskTexts).to.include('Задача 1')
        expect(taskTexts).to.include('Задача 2')
        expect(taskTexts).to.include('Задача 3')
      })
  })

  // Тест 5: each() з умовною логікою
  // each() дозволяє виконувати різні дії залежно від умов
  it('має використовувати умовну логіку в each()', () => {
    // Відмічаємо першу задачу
    cy.get('.todo-list li').first().find('.toggle').check()
    
    // Ітеруємо та перевіряємо стан кожної задачі
    cy.get('.todo-list li')
      .each(($el, index) => {
        if (index === 0) {
          // Перша задача має бути виконаною
          cy.wrap($el)
            .should('have.class', 'completed')
        } else {
          // Інші задачі мають бути активними
          cy.wrap($el)
            .should('not.have.class', 'completed')
        }
      })
  })

  // Тест 6: Практичний приклад - масові операції
  // Використання each() для масових операцій над елементами
  it('має виконувати масові операції через each()', () => {
    // Відмічаємо всі задачі як виконані
    cy.get('.todo-list li')
      .each(($el) => {
        cy.wrap($el)
          .find('.toggle')
          .check()
      })
    
    // Перевіряємо результат
    cy.get('.todo-list li.completed')
      .should('have.length', 3)
    
    // Знімаємо відмітку з усіх задач
    cy.get('.todo-list li')
      .each(($el) => {
        cy.wrap($el)
          .find('.toggle')
          .uncheck()
      })
    
    // Перевіряємо результат
    cy.get('.todo-list li.completed')
      .should('have.length', 0)
  })
})

// ============================================================
// ВАЖЛИВІ ЗАУВАЖЕННЯ про each():
// ============================================================
// 1. each() виконує функцію для кожного елемента послідовно
// 2. $el - це jQuery елемент, потрібно обгортати в cy.wrap() для Cypress команд
// 3. index починається з 0 (не з 1!)
// 4. $list - це весь список елементів
// 5. each() чекає на завершення кожної ітерації перед наступною
// 6. Використовуйте each() коли потрібно виконати дії над кожним елементом
// ============================================================
